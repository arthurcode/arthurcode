{% load comment %}
{% load mptt_tags %}

<div id="comments">
    {% get_comment_list for post as comments %}
    {% get_comment_count for post as comment_count %}

    <h2>Comments ({{ comment_count }})</h2>
    {% if comments %}
        <ul class="comments">
            {% recursetree comments %}
                <li class="comment">
                    <a name="c{{ node.id }}"></a>
                    <span class="user">{{ node.user_name }}</span>
                    <a class="date" href="{% get_comment_permalink node %}">{{ node.submit_date|timesince }} ago</a>
                    <div class="text">
                        {% if not node.is_removed %}
                            {{ node.comment }}
                        {% else %}
                            <em>(Comment has been removed)</em>
                        {% endif %}
                    </div>
                    {% with node as comment %}
                        {% include 'blog/post_comment_moderation_opts.html' %}
                    {% endwith %}
                    {% if post.is_commenting_enabled and not node.is_removed %}
                        <button id="reply">Reply</button>
                        {% render_comment_form for post %}
                    {% endif %}
                    {% if not node.is_leaf_node %}
                        <ul class="comments">{{ children }}</ul>
                    {% endif %}
                </li>
            {% endrecursetree %}
        </ul>
    {% endif %}
    {% if post.is_commenting_enabled %}
        {% if user.is_authenticated %}Hello, <span class="user">{{ user.username }}</span>.{% endif %}
        Please leave a comment:
        {% render_comment_form for post %}
    {% else %}
        Comments are disabled
    {% endif %}
</div>