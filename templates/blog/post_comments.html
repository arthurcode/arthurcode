{% load comment %}
{% load mptt_tags %}
{% load blog_extras %}

<div id="comments">
    {% get_comment_list for post as comments %}
    {% get_comment_count for post as comment_count %}

    <h2>Comments ({{ comment_count }})</h2>
    {% if comments %}
        <ul class="comments">
            {% recursetree comments %}
                <li class="comment">
                    <a name="{% comment_anchor node %}"></a>
                    <span class="user">{{ node.user_name }}</span>
                    <a class="date" href="{% comment_permalink node %}">{{ node.submit_date|timesince }} ago</a>
                    <div class="text">
                        {% if not node.is_removed %}
                            {{ node.comment }}
                        {% else %}
                            <em>(Comment has been removed)</em>
                        {% endif %}
                    </div>
                    {% if post.is_commenting_enabled and not node.is_removed %}
                        <button id="reply">Reply</button>
                        {% render_comment_form for post %}
                    {% endif %}
                    {% if not node.is_leaf_node %}
                        <ul class="comments">{{ children }}</ul>
                    {% endif %}
                </li>
            {% endrecursetree %}
        </ul>
    {% endif %}
    {% if post.is_commenting_enabled %}
        {% if user.is_authenticated %}Hello, <span class="user">{{ user.username }}</span>.{% endif %}
        Please leave a comment:
        {% render_comment_form for post %}
    {% else %}
        Comments are disabled
    {% endif %}
</div>

<script type="text/javascript">
    YUI().use('node', function(Y) {
        // initially hide all comment reply forms
        Y.all('.comment form').each(function(f) {
            f.addClass('hidden');
        });

        // toggle the reply form visibility when the reply button is hit
        Y.delegate('click', function(e) {
            var form = e.currentTarget.next('form');
            form.toggleClass('hidden');
        }, document, 'button#reply');
    });
</script>