{% extends "base_catalogue.html" %}

{% load extras %}
{% load urls %}
{% load form_tags %}
{% load ratings %}
{% load catalogue_extras %}

{% block title %}{{ product.name }}{% endblock %}

{% if breadcrumbs %}{% block root-category %}{{ breadcrumbs.0.slug }}{% endblock %}{% endif %}

{% block body %}
    <div class="breadcrumbs">
        <a href="{% go_to_category '' %}">All Products</a> >
        {% for crumb in breadcrumbs %}
            <a href="{% go_to_category crumb.slug %}">{{ crumb.name }}</a> >
        {% endfor %}
        {{ product.name }}
    </div>

    <div class="product-detail">
        <div class="visual">
            <div id="primary-img">
                {% if images %}
                    <a href="{{ STATIC_URL }}{{ images.0.detail_path }}"><img src="{{ STATIC_URL }}{{ images.0.path }}" alt="{{ images.0.alt_text }}"></a>
                    <p>click on picture for a larger view</p>
                {% else %}
                    <img src="{{ STATIC_URL }}products/no_image_available.png" alt="no image available">
                {% endif %}
            </div>
            {% if images|length > 1 %}
                <div class="other-views">
                    {% for image in images %}
                        <a href="{{ STATIC_URL }}{{ image.detail_path }}"><img id="image-{{ image.id }}" alt="{{ image.alt_text }}" style="visibility:hidden"></a>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div class="description">
            <h1>{{ product.name }}{% if product.sale_price %} <span class="sale">(On Sale!)</span>{% endif %}</h1>
            {% rating avg_rating %}
            {% if avg_rating %}
                ({{ reviews.count }} <a class="tabview" href="#reviews">review{{ reviews.count|pluralize:",s" }}</a>)
            {% else %}
                <a href="{% url product_review product.slug %}">(be the first to write a review)</a>
            {% endif %}
            {% if not product.in_stock %}
                <span class="out-of-stock">Out Of Stock</span>
            {% endif %}

            <div class="fb-like" data-href="http://developers.facebook.com/docs/reference/plugins/like" data-send="true" data-width="450" data-show-faces="false" data-font="arial" data-layout="button_count"></div>

            <div id="summary">
                {% autoescape off %}
                    <div class="text">{{ product.short_description }}</div>
                {% endautoescape %}
                <br>
                <a href="#more-detail">read more</a>
            </div>

            <div class="add-to-cart">
                <div class="price">
                    {% if product.sale_price %}
                        <span class="sale-price">{{ product.sale_price|currency }}</span>
                        <span class="you-save">Was: <span class="old-price">{{ product.price|currency }}</span> ({{ product.percent_savings|floatformat:0 }}% off!)</span>
                    {% else %}
                        <span class="normal-price">{{ product.price|currency }}</span>
                    {% endif %}
                </div>
                {% form_errors form %}
                {% if product.in_stock %}
                    <form method="post" action="{% url catalogue_product product.slug %}" class="add-to-cart">
                        {% csrf_token %}
                        {% if form.color %}
                            {% product_option_field form.color %}
                        {% endif %}
                        {% if form.size %}
                            {% product_option_field form.size %}
                        {% endif %}
                        {% field form.quantity %}
                        <button type="submit" name="submit" class="action">Add to Cart</button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div id="more-detail">
            <h3><a href="#more-detail">Full Description</a></h3>
            {% autoescape off %}<div class="text">{{ product.long_description }}</div>{% endautoescape %}
        </div>
    </div>

    <div id="feedback" class="tabview">
        <ul class="tabrow">
            <li class="tab selected" id="reviews"><a class="tabview" href="#reviews">Reviews ({{ reviews.count }})</a></li>
            <li class="tab" id="qa"><a class="tabview" href="#qa">Q & A</a></li>
        </ul>
        <div class="views">
            <div class="view" id="reviews">{% include "_reviews.html" %}</div>
            <div class="view hide-initially" id="qa">{% include "_questions.html" %}</div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script type="text/javascript">
        YUI().use('event', 'panel', 'imageloader', 'node-event-simulate', 'custom', function(Y) {

            // lazy loading of product's images (except for the first, primary image)
            var imageGroup = new Y.ImgLoadGroup({foldDistance: 30});
            // iterate over every image, and register the image-{id} div with the appropriate source image
            {% for image in images %}
                imageGroup.registerImage({
                    domId: "image-" + "{{ image.id }}",
                    srcUrl: "{{ STATIC_URL }}{{ image.path }}",
                    setVisible: true
                });
            {% endfor %}


            // configure image selector
            var images = Y.all('div.other-views img');
            images.each(function(image) {
               image.on("click", function(e) {
                  e.preventDefault();
                  var src = image.get('src');
                  var alt = image.get('alt');
                  var primary_image = Y.one('#primary-img img');
                  if (primary_image) {
                      primary_image.set('src', src);
                      primary_image.set('alt', alt);
                      var primary_link = primary_image.ancestor('a');
                      var clicked_link = image.ancestor('a');
                      if (primary_link && clicked_link) {
                          primary_link.set('href', clicked_link.get('href'));
                      }
                  }
               });
            });

            // load a high resolution image in a panel when the primary image is clicked
            var primary_image = Y.one('#primary-img img');
            if (primary_image) {
                primary_image.on("click", function(e) {
                    var parent_link = primary_image.ancestor('a');
                    if (parent_link) {
                        // default behaviour is to link to the high-res image in a new window
                        e.preventDefault();
                        var detail_src = parent_link.get('href');
                        var bodyContent = '<img src="' + detail_src + '">';
                        var panel = new Y.Panel({
                            headerContent: "{{ product.name }}",
                            bodyContent: bodyContent,
                            centered: true,
                            zIndex: 100,
                            modal: true,
                            render: true
                        });
                    }
                });
            }

            Y.Custom.radioImageForm(Y.one('.add-to-cart form'));

            var option_to_stock_map = JSON.parse('{{ option_to_stock_map|escapejs }}');  // parse to javascript map

            function check_option_stock() {
                var options = Y.all('.radio-image');

                options.each(function() {
                    this.removeClass('unavailable'); // start fresh

                    var id = this.getAttribute('id');
                    if (!option_to_stock_map[id]) {
                        // option is out of stock
                        this.addClass('unavailable');
                    }
                });

                var fieldsets = Y.all('.add-to-cart div.radio fieldset');
                if (fieldsets.size() == 2) {
                    // the only amount of option categories we can handle right now I'm afraid
                    var set_1 = fieldsets.item(0);
                    var set_2 = fieldsets.item(1);
                    var selected_1 = set_1.one('.radio-image.selected');
                    var selected_2 = set_2.one('.radio-image.selected');
                    if (selected_1 || selected_2) {
                        if (selected_1) {
                            var id = selected_1.getAttribute('id');
                            var display = set_1.one('.chosen-radio');
                            set_2.all('.radio-image').each(function() {
                                var key = id + "," + this.getAttribute('id');
                                if (!(key in option_to_stock_map) || option_to_stock_map[key] == 0) {
                                    this.addClass('unavailable');
                                }
                            });
                        }
                        if (selected_2) {
                            var id = selected_2.getAttribute('id');
                            var display = set_2.one('.chosen-radio');
                            set_1.all('.radio-image').each(function() {
                                var key = id + "," + this.getAttribute('id');
                                if (!(key in option_to_stock_map) || option_to_stock_map[key] == 0) {
                                    this.addClass('unavailable');
                                }
                            });
                        }
                    }
                }

                // set the display value
                fieldsets.each(function() {
                   var display = this.one('.chosen-radio');
                   var selected = this.one('.radio-image.selected');
                   if (selected) {
                       display.setHTML(Y.Custom.get_radio_image_display(selected));
                   }
                });
            }

            var option_to_image_map = JSON.parse('{{ option_to_image_map|escapejs }}');  // parse to javascript map

            Y.all('.radio-image').each(function(radio) {
                radio.on('click', function(e) {
                    check_option_stock();
                    var id = radio.getAttribute('id');
                    // if this option is linked to an alternate product image, load it.
                    if (id in option_to_image_map) {
                        var image_id = option_to_image_map[id];
                        var image = Y.one('div.other-views img#image-' + image_id);
                        if (image) {
                            image.simulate("click");
                        }
                    }
                });
            });
            check_option_stock();


            // hook up increment & decrement buttons for the quantity field
            var field = Y.one('.add-to-cart .field.text');
            if (field) {
                var incrementor = Y.Node.create("<button type='button'>+</button>");
                var decrementor = Y.Node.create("<button type='button'>-</button>");
                field.one('.column1').append(incrementor);
                field.one('.column1').append(decrementor);

                incrementor.on("click", function(e) {
                    var input = field.one("input");
                    var currentValue = input.get('value');
                    var newValue = currentValue*1 + 1;
                    if (newValue) {
                        input.set('value', newValue);
                    }
                });

                decrementor.on("click", function(e) {
                    var input = field.one("input");
                    var currentValue = input.get('value');
                    var newValue = currentValue*1 - 1;
                    if (newValue) {
                        if (newValue < 1) {
                            newValue = 1;
                        }
                        input.set('value', newValue);
                    }
                })
            }

            // custom add-to-cart form validation
            var form = Y.one('.add-to-cart form');
            if (form) {
                var button = form.one('button.action');
                if (button) {
                    button.on('click', function(e) {
                        var found_error = false;
                        form.all('fieldset').each(function(fieldset) {
                            // make sure that an option has been selected
                            var selected = fieldset.one('.radio-image.selected');
                            if (!selected) {
                                found_error = true;
                                var message = "Please choose a " + fieldset.one('legend').getHTML().toLowerCase();
                                Y.Custom.setFieldError(fieldset.ancestor('.field'), message, true);
                            }
                        });
                        var quantity_input = form.one('input#id_quantity');
                        var quantity = quantity_input.get('value');
                        var field = quantity_input.ancestor('.field');

                        if (!quantity) {
                            found_error = true;
                            Y.Custom.setFieldError(field, "Please enter a quantity", true);
                        } else {
                            var int_quantity = parseInt(quantity);
                            if (!int_quantity || int_quantity < 1) {
                                found_error = true;
                                Y.Custom.setFieldError(field, "Please enter a number larger than zero", true);
                            }
                        }
                        if (found_error) {
                            e.preventDefault()
                        }
                    });
                }

                // make all errors in the add-to-cart form pop up like tooltips
                form.all('.field.error').each(function(field) {
                    Y.Custom.popupFieldError(field);
                });
            }
        });
    </script>
{% endblock %}